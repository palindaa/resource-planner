{% extends "base.html" %}

{% block content %}
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="mb-8 border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-800">Resource Allocation</h1>
        <p class="mt-2 text-sm text-gray-600">View-only timeline of employee assignments</p>
    </div>

    <div class="flex">
        <!-- Gantt Chart Column -->
        <div class="flex-1 overflow-x-auto">
            <div class="bg-white p-4 rounded-lg shadow">
                <!-- Add dashboard container -->
                <div id="dashboard_div">
                    <div id="filter_div" style="height: 50px; width: 100%;"></div>
                    <div id="timeline" style="height: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const users = JSON.parse('{{ users|tojson|safe }}');
            
            // Prepare data for Google Timeline
            const dataTableRows = [];
            users.forEach(user => {
                user.tasks.forEach(task => {
                    dataTableRows.push([
                        user.name,          // Resource (employee name)
                        task.name,          // Task name
                        task.color,         // Bar color
                        new Date(task.start), 
                        new Date(task.end),
                    ]);
                });
            });

            // Load Google Charts with controls package
            google.charts.load('current', {'packages':['timeline', 'controls']});
            google.charts.setOnLoadCallback(drawDashboard);

            function drawDashboard() {
                const dashboard = new google.visualization.Dashboard(
                    document.getElementById('dashboard_div')
                );

                // Create the DataTable first
                const dataTable = new google.visualization.DataTable();

                // Define columns for the timeline
                dataTable.addColumn({ type: 'string', id: 'Employee' });
                dataTable.addColumn({ type: 'string', id: 'Task' });
                dataTable.addColumn({ type: 'string', role: 'style' });
                dataTable.addColumn({ type: 'string', role: 'tooltip' });
                dataTable.addColumn({ type: 'date', id: 'Start' });
                dataTable.addColumn({ type: 'date', id: 'End' });
                
                dataTable.addRows(dataTableRows.map(row => {
                    const start = row[3];
                    const end = row[4];
                    const durationDays = Math.round((end - start) / 86400000);
                    const tooltip = `
                        <div style="padding:10px;">
                            <strong>${row[0]}</strong><br>
                            Project: ${row[1]}<br>
                            Start: ${start.toLocaleDateString()}<br>
                            End: ${end.toLocaleDateString()}<br>
                            Duration: ${durationDays} days
                        </div>
                    `;
                    console.log('Color', row[2]);
                    return [
                        row[0],        // Employee
                        row[1],        // Task
                        `color: ${row[2]}`,  // Properly formatted color style
                        tooltip,       // Tooltip
                        start,         // Start date
                        end         // End date
                    ];
                }));

                // Compute daily ticks for range filter axis
                const startDates = dataTableRows.map(r => r[3]);
                const endDates = dataTableRows.map(r => r[4]);
                const minTime = Math.min(...startDates.map(d => d.getTime()));
                const maxTime = Math.max(...endDates.map(d => d.getTime()));
                const minDate = new Date(minTime);
                const maxDate = new Date(maxTime);
                const dailyTicks = [];
                for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
                    dailyTicks.push(new Date(d));
                }

                // Create range filter control
                const rangeFilter = new google.visualization.ControlWrapper({
                    controlType: 'ChartRangeFilter',
                    containerId: 'filter_div',
                    options: {
                        filterColumnIndex: 5,  // Index of Start Date column
                        ui: {
                            chartType: 'LineChart',
                            chartOptions: {
                                chartArea: {width: '80%'},
                                hAxis: {
                                    baselineColor: 'none',
                                    ticks: dailyTicks,
                                    format: 'MMM dd'
                                }
                            },
                            chartView: {
                                columns: [4, 5]  // Show start and end dates
                            }
                        }
                    }
                });

                // Create timeline chart wrapper
                const timelineChart = new google.visualization.ChartWrapper({
                    chartType: 'Timeline',
                    containerId: 'timeline',
                    options: {
                        timeline: { 
                            showRowLabels: true,
                            colorByRowLabel: false
                        },
                        tooltip: { isHtml: true },
                        height: users.length * 40 + 80
                    }
                });

                // Establish dependencies and draw
                dashboard.bind(rangeFilter, timelineChart);
                dashboard.draw(dataTable);
            }
        });
    </script>
</div>
{% endblock %} 